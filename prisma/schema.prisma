generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres", "driverAdapters"]
}

generator jsonSchema {
  provider              = "prisma-json-schema-generator"
  includeRequiredFields = "true"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator kysely {
  provider        = "prisma-kysely"
  previewFeatures = ["fullTextSearchPostgres"]
  output          = "./kysely"
}

generator types {
  provider = "prisma-type-generator"
  output   = "../src/server/types"
}

model Session {
  id         String   @id
  user_id    String
  expires_at DateTime
  user       User     @relation(references: [id], fields: [user_id], onDelete: Cascade)
  ip_address String?  @db.VarChar(45)
  user_agent String?
}

model OauthAccount {
  id             String @id @default(cuid())
  providerId     String
  providerUserId String
  userId         String
  user           User   @relation(references: [id], fields: [userId], onDelete: Cascade)

  @@unique([providerId, providerUserId])
}

model User {
  id            String         @id
  username      String         @unique
  password_hash String?
  email         String?        @unique
  sessions      Session[]
  oauthAccounts OauthAccount[]
  role          UserRole       @default(USER)

  // User profile information
  name             String?
  firstName        String?
  lastName         String?
  profileImageUrl  String?     @db.Text
  bio              String?     @db.Text
  timezone         String?
  language         String?     @default("en")
  
  // Professional details
  jobTitle         String?
  department       String?
  employeeId       String?
  hireDate         DateTime?
  yearsOfExperience Int?
  skills           String[]   @default([])
  
  // Contact information
  phoneNumber      String?
  businessEmail    String?
  businessPhone    String?
  officeLocation   String?
  
  // Organization data
  organizationName String?
  organizationUnit String?
  managerUserId    String?    // Self-relation to manager
  manager          User?      @relation("UserManagement", fields: [managerUserId], references: [id], onDelete: SetNull)
  directReports    User[]     @relation("UserManagement")
  teamName         String?
  
  // Business address
  addressLine1     String?
  addressLine2     String?
  city             String?
  state            String?
  postalCode       String?
  country          String?
  
  // Preferences
  notificationPreferences Json?
  displayPreferences     Json?
  documentPreferences    Json?
  
  // Social profiles
  linkedinProfile  String?
  twitterProfile   String?
  githubProfile    String?
  
  // System information
  version          Int     @default(1)
  stripeCustomerId String? @unique
  accountStatus    AccountStatus @default(ACTIVE)
  lastLoginAt      DateTime?
  uploadLimit      Int     @default(100000000)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now())
  deletedAt DateTime?

  documents        Document[]
  comments         Comment[]
  files            File[]
  discussions      Discussion[]
  documentVersions DocumentVersion[]

  @@index([username])
  @@index([email])
  @@index([organizationName])
}

model Document {
  id         String  @id
  templateId String?

  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId           String
  parentDocumentId String?
  parentDocument   Document?  @relation("ParentChild", fields: [parentDocumentId], references: [id])
  children         Document[] @relation("ParentChild")

  title       String?
  content     String?
  contentRich Json?
  coverImage  String?
  icon        String?
  isPublished Boolean @default(false)
  isArchived  Boolean @default(false)
  pinned      Boolean @default(false)
  tags        String[] @default([])
  isTemplate  Boolean @default(false)
  status      String @default("draft")

  textStyle TextStyle @default(DEFAULT)
  smallText Boolean   @default(false)
  fullWidth Boolean   @default(false)
  lockPage  Boolean   @default(false)
  toc       Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  discussions      Discussion[]
  documentVersions DocumentVersion[]
  files            File[]

  @@unique([userId, templateId])
}

model DocumentVersion {
  id         String   @id
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String?
  contentRich Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Discussion {
  id String @id

  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  documentContent     String
  documentContentRich Json?
  isResolved          Boolean   @default(false)
  comments            Comment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Comment {
  id String @id

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  discussionId String
  discussion   Discussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)

  content     String
  contentRich Json?
  isEdited    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model File {
  id String @id

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  documentId String?
  document   Document? @relation(fields: [documentId], references: [id])

  size   Int
  url    String @db.Text
  appUrl String @db.Text
  type   String

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

enum UserRole {
  USER
  ADMIN
  SUPERADMIN
  MANAGER
  EDITOR
  VIEWER
  GUEST
}

enum TextStyle {
  DEFAULT
  SERIF
  MONO
}

enum AccountStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
  ARCHIVED
}
